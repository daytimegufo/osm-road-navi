<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄöÁß∞ÈÅìË∑ØÊåáÂÆö„Éä„Éì - ÊîπÂñÑÁâà</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        .control-panel {
            width: 400px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .nav-section {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .nav-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .location-input {
            margin-bottom: 15px;
        }

        .location-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
            color: #555;
        }

        .input-group {
            position: relative;
            display: flex;
            gap: 5px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn-icon {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-icon:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .via-point {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .via-point:hover {
            border-color: #3498db;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.1);
        }

        .via-point-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .via-point-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .btn-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .road-name-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .road-status {
            font-size: 12px;
            padding: 5px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .road-status.found {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .road-status.not-found {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .road-status.searching {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .route-info {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .route-info h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .route-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.8em;
            color: #7f8c8d;
            text-transform: uppercase;
        }

        #viaRoadsList {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            line-height: 1.8;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .map-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .map-btn:hover {
            background: white;
            transform: translateY(-1px);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            padding: 10px;
            margin: 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                height: auto;
            }
            
            .control-panel {
                width: 100%;
                order: 2;
                max-height: 50vh;
            }
            
            .map-container {
                height: 50vh;
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="control-panel">
            <div class="header">
                <h1>üöó ÈÄöÁß∞ÈÅìË∑ØÊåáÂÆö„Éä„Éì (ÊîπÂñÑÁâà)</h1>
                <p>Ê≠£Á¢∫„Å™ÈÅìË∑ØËøΩÂæì„É´„Éº„ÉàÁîüÊàê</p>
            </div>
            
            <div class="nav-section">
                <h3>üìç Âá∫Áô∫Âú∞„ÉªÁõÆÁöÑÂú∞</h3>
                
                <div class="location-input">
                    <label>Âá∫Áô∫Âú∞</label>
                    <div class="input-group">
                        <input type="text" id="startLocation" placeholder="‰ΩèÊâÄ„Åæ„Åü„ÅØÂú∞Âêç„ÇíÂÖ•Âäõ">
                        <button class="btn-icon" onclick="getCurrentLocation('start')" title="ÁèæÂú®Âú∞„ÇíÂèñÂæó">üìç</button>
                    </div>
                </div>
                
                <div class="location-input">
                    <label>ÁõÆÁöÑÂú∞</label>
                    <div class="input-group">
                        <input type="text" id="endLocation" placeholder="‰ΩèÊâÄ„Åæ„Åü„ÅØÂú∞Âêç„ÇíÂÖ•Âäõ">
                        <button class="btn-icon" onclick="setLocationFromMap('end')" title="Âú∞Âõ≥„Åã„ÇâÈÅ∏Êäû">üó∫Ô∏è</button>
                    </div>
                </div>
            </div>
            
            <div class="nav-section">
                <h3>üõ£Ô∏è ÁµåÁî±ÈÅìË∑ØÔºàÈÄöÁß∞ÂêçÔºâ</h3>
                
                <div id="viaPoints"></div>
                
                <button class="btn-secondary" onclick="addViaPoint()">‚ûï ÁµåÁî±ÈÅìË∑Ø„ÇíËøΩÂä†</button>
                
                <button class="btn-primary" onclick="calculateRoute()" id="calculateBtn">
                    üß≠ „É´„Éº„ÉàÁîüÊàê (‰∫§Â∑ÆÁÇπÁµåÁî±)
                </button>
                
                <button class="btn-secondary" onclick="clearRoute()">üóëÔ∏è „ÇØ„É™„Ç¢</button>
            </div>
            
            <div class="nav-section" id="routeInfoSection" style="display: none;">
                <div class="route-info">
                    <h4>üìä „É´„Éº„ÉàÊÉÖÂ†±</h4>
                    <div class="route-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="routeDistance">-</div>
                            <div class="stat-label">Ë∑ùÈõ¢</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="routeTime">-</div>
                            <div class="stat-label">ÊôÇÈñì</div>
                        </div>
                    </div>
                    
                    <h4>üõ£Ô∏è ÁµåÁî±ÈÅìË∑Ø</h4>
                    <div id="viaRoadsList" style="margin-top: 10px; font-size: 14px;"></div>
                </div>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-btn" onclick="centerMap()" title="ÁèæÂú®Âú∞„Å´ÁßªÂãï">üéØ</button>
                <button class="map-btn" onclick="fitRoute()" title="„É´„Éº„ÉàÂÖ®‰Ωì„ÇíË°®Á§∫">üîç</button>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let map;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;
        let viaMarkersLayer = null;
        let currentRoute = null;
        let viaPointCounter = 0;
        let isSelectingLocation = false;
        let locationSelectType = null;

        // „Ç¢„Ç§„Ç≥„É≥ÂÆöÁæ©
        const icons = {
            start: L.divIcon({
                html: '<div style="background: #27ae60; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üöó</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            end: L.divIcon({
                html: '<div style="background: #e74c3c; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üèÅ</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            }),
            via: L.divIcon({
                html: '<div style="background: #f39c12; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">üìç</div>',
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            })
        };

        // Ë∑ùÈõ¢Ë®àÁÆóÈñ¢Êï∞
        function calculateDistance(p1, p2) {
            const R = 6371; // Âú∞ÁêÉ„ÅÆÂçäÂæÑ (km)
            const dLat = (p2.lat - p1.lat) * Math.PI / 180;
            const dLng = (p2.lng - p1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Â∫ßÊ®ôÈÖçÂàó„ÅÆ„ÉÄ„Ç¶„É≥„Çµ„É≥„Éó„É™„É≥„Ç∞ÔºàMap Matching API„ÅÆÂà∂ÈôêÂØæÂøúÔºâ
        function downsampleCoordinates(coords, maxPoints = 90) {
            if (coords.length <= maxPoints) return coords;
            
            const step = Math.ceil(coords.length / maxPoints);
            const sampled = [];
            
            // ÊúÄÂàù„ÅÆÁÇπ„ÇíÂøÖ„ÅöÂê´„ÇÅ„Çã
            sampled.push(coords[0]);
            
            // ‰∏≠ÈñìÁÇπ„ÇíÂùáÁ≠â„Å´„Çµ„É≥„Éó„É™„É≥„Ç∞
            for (let i = step; i < coords.length - 1; i += step) {
                sampled.push(coords[i]);
            }
            
            // ÊúÄÂæå„ÅÆÁÇπ„ÇíÂøÖ„ÅöÂê´„ÇÅ„Çã
            sampled.push(coords[coords.length - 1]);
            
            return sampled;
        }

        // OSRM Map Matching API„Çí‰ΩøÁî®„Åó„Å¶ÈÅìË∑Ø„Å´Ê≤ø„Å£„Åü„É´„Éº„Éà„ÇíÂèñÂæó
        async function getMatchedRoute(coordinates) {
            console.log('Map Matching ÈñãÂßã:', coordinates.length + 'ÁÇπ');
            
            // Â∫ßÊ®ôÊï∞„ÅåÂ§ö„Åô„Åé„ÇãÂ†¥Âêà„ÅØ„ÉÄ„Ç¶„É≥„Çµ„É≥„Éó„É™„É≥„Ç∞
            const sampledCoords = downsampleCoordinates(coordinates, 90);
            console.log('„Çµ„É≥„Éó„É™„É≥„Ç∞Âæå:', sampledCoords.length + 'ÁÇπ');
            
            // Map Matching APIÁî®„ÅÆÂ∫ßÊ®ôÊñáÂ≠óÂàó„ÇíÊßãÁØâ
            const coordString = sampledCoords
                .map(coord => `${coord[1]},${coord[0]}`) // [lng,lat]ÂΩ¢Âºè
                .join(';');
            
            const url = `https://router.project-osrm.org/match/v1/driving/${coordString}?` +
                      `geometries=geojson&overview=full&tidy=true&radiuses=${sampledCoords.map(() => '25').join(';')}`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.matchings && data.matchings.length > 0) {
                    return data.matchings[0].geometry;
                } else {
                    console.warn('Map Matching Â§±Êïó:', data);
                    return null;
                }
            } catch (error) {
                console.error('Map Matching „Ç®„É©„Éº:', error);
                return null;
            }
        }

        // 2ÁÇπÈñì„ÅÆÊé•Á∂ö„É´„Éº„Éà„ÇíÂèñÂæó
        async function getConnectionRoute(point1, point2) {
            const url = `https://router.project-osrm.org/route/v1/driving/` +
                       `${point1.lng},${point1.lat};${point2.lng},${point2.lat}?` +
                       `overview=full&geometries=geojson`;
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.routes && data.routes.length > 0) {
                    return data.routes[0].geometry;
                }
                return null;
            } catch (error) {
                console.error('Êé•Á∂ö„É´„Éº„ÉàÂèñÂæó„Ç®„É©„Éº:', error);
                return null;
            }
        }

        // ‰∫§Â∑ÆÁÇπ„Åã„ÇâÊúÄÈÅ©„Å™ÂÖ•Âè£„ÉªÂá∫Âè£„ÇíÈÅ∏Êäû„Åô„ÇãÈñ¢Êï∞ÔºàÊîπÂñÑÁâàÔºâ
        function selectIntersections(intersections, prevPoint, nextPoint, roadSegments) {
            if (!intersections || intersections.length === 0) {
                return { entryIntersection: null, exitIntersection: null };
            }

            // ÈÅìË∑Ø„ÅÆÂÖ®Â∫ßÊ®ô„Åã„ÇâÈÅìË∑Ø„ÅÆÊñπÂêë„ÇíÂà§ÂÆö
            let roadDirection = null;
            if (roadSegments && roadSegments.length > 0) {
                const firstSeg = roadSegments[0];
                const lastSeg = roadSegments[roadSegments.length - 1];
                const firstCoords = firstSeg.coordinates || firstSeg;
                const lastCoords = lastSeg.coordinates || lastSeg;
                
                if (Array.isArray(firstCoords) && firstCoords.length > 0 && 
                    Array.isArray(lastCoords) && lastCoords.length > 0) {
                    const startPoint = {
                        lat: firstCoords[0][0],
                        lng: firstCoords[0][1]
                    };
                    const endPoint = {
                        lat: lastCoords[lastCoords.length - 1][0],
                        lng: lastCoords[lastCoords.length - 1][1]
                    };
                    
                    // ÈÅìË∑Ø„ÅÆÊñπÂêë„ÇíÂà§ÂÆöÔºàÂá∫Áô∫Âú∞„Å´„Çà„ÇäËøë„ÅÑÊñπ„ÅåÈÅìË∑Ø„ÅÆÂßãÁÇπÔºâ
                    const distStartToPrev = calculateDistance(startPoint, prevPoint);
                    const distEndToPrev = calculateDistance(endPoint, prevPoint);
                    roadDirection = distStartToPrev < distEndToPrev ? 'forward' : 'reverse';
                }
            }

            // ‰∫§Â∑ÆÁÇπ„ÇíË©ï‰æ°„Åó„Å¶ÊúÄÈÅ©„Å™„ÇÇ„ÅÆ„ÇíÈÅ∏Êäû
            const evaluatedIntersections = intersections.map(intersection => {
                const distFromPrev = calculateDistance(prevPoint, intersection);
                const distToNext = calculateDistance(intersection, nextPoint);
                const totalDistance = distFromPrev + distToNext;
                
                // ÈÅìË∑Ø‰∏ä„ÅÆ‰ΩçÁΩÆ„ÇíÂà§ÂÆöÔºà0=ÂßãÁÇπ„ÄÅ1=ÁµÇÁÇπÔºâ
                let positionOnRoad = 0.5;
                if (roadSegments) {
                    let minDist = Infinity;
                    let totalLength = 0;
                    let positionLength = 0;
                    
                    roadSegments.forEach(seg => {
                        const coordinates = seg.coordinates || seg;
                        if (Array.isArray(coordinates)) {
                            for (let i = 0; i < coordinates.length; i++) {
                                const coord = coordinates[i];
                                if (Array.isArray(coord) && coord.length >= 2) {
                                    const point = { lat: coord[0], lng: coord[1] };
                                    const dist = calculateDistance(point, intersection);
                                    
                                    if (dist < minDist) {
                                        minDist = dist;
                                        positionLength = totalLength + i;
                                    }
                                    
                                    if (i > 0) {
                                        const prevCoord = coordinates[i - 1];
                                        const prevPoint = { lat: prevCoord[0], lng: prevCoord[1] };
                                        totalLength += calculateDistance(prevPoint, point);
                                    }
                                }
                            }
                        }
                    });
                    
                    if (totalLength > 0) {
                        positionOnRoad = positionLength / totalLength;
                    }
                }
                
                return {
                    intersection,
                    distFromPrev,
                    distToNext,
                    totalDistance,
                    positionOnRoad,
                    score: 0 // Âæå„ÅßË®àÁÆó
                };
            });

            // „Çπ„Ç≥„Ç¢„ÇíË®àÁÆóÔºà‰Ωé„ÅÑ„Åª„Å©ËâØ„ÅÑÔºâ
            evaluatedIntersections.forEach(evalInt => {
                // Âü∫Êú¨„Çπ„Ç≥„Ç¢ÔºöÁ∑èË∑ùÈõ¢
                evalInt.score = evalInt.totalDistance;
                
                // ‰∫§Â∑ÆÁÇπ„Çø„Ç§„Éó„Å´„Çà„Çã„Éú„Éº„Éä„Çπ
                if (evalInt.intersection.type === 'intersection') {
                    evalInt.score *= 0.7; // ‰∫§Â∑ÆÁÇπ„Çí„Çà„ÇäÂÑ™ÂÖà
                }
                
                // Êé•Á∂öÊï∞„Å´„Çà„Çã„Éú„Éº„Éä„Çπ
                if (evalInt.intersection.connectionCount > 3) {
                    evalInt.score *= 0.8; // ‰∏ªË¶Å‰∫§Â∑ÆÁÇπ„Çí„Çà„ÇäÂÑ™ÂÖà
                } else if (evalInt.intersection.connectionCount > 2) {
                    evalInt.score *= 0.9;
                }
                
                // ËøΩÂä†‰∫§Â∑ÆÁÇπ„ÅÆÂ†¥Âêà„ÅØ„Éú„Éº„Éä„Çπ
                if (evalInt.intersection.isAdditional) {
                    evalInt.score *= 0.85;
                }
            });

            // ÂÖ•Âè£‰∫§Â∑ÆÁÇπ„ÇíÈÅ∏ÊäûÔºàÂâç„ÅÆÂú∞ÁÇπ„Å´Ëøë„Åè„ÄÅÈÅìË∑Ø„ÅÆÂâçÂçä„Å´„ÅÇ„Çã„ÇÇ„ÅÆÔºâ
            const entryCandidate = evaluatedIntersections
                .filter(e => e.positionOnRoad < 0.7) // ÈÅìË∑Ø„ÅÆÂæåÂçä70%„Çà„ÇäÂâç
                .sort((a, b) => {
                    // Ââç„ÅÆÂú∞ÁÇπ„Åã„Çâ„ÅÆË∑ùÈõ¢„ÇíÈáçË¶ñ
                    const scoreA = a.distFromPrev * 2 + a.distToNext;
                    const scoreB = b.distFromPrev * 2 + b.distToNext;
                    return scoreA - scoreB;
                })[0];

            // Âá∫Âè£‰∫§Â∑ÆÁÇπ„ÇíÈÅ∏ÊäûÔºàÊ¨°„ÅÆÂú∞ÁÇπ„Å´Ëøë„Åè„ÄÅÈÅìË∑Ø„ÅÆÂæåÂçä„Å´„ÅÇ„Çã„ÇÇ„ÅÆÔºâ
            const exitCandidate = evaluatedIntersections
                .filter(e => e.positionOnRoad > 0.3) // ÈÅìË∑Ø„ÅÆÂâçÂçä30%„Çà„ÇäÂæå
                .sort((a, b) => {
                    // Ê¨°„ÅÆÂú∞ÁÇπ„Å∏„ÅÆË∑ùÈõ¢„ÇíÈáçË¶ñ
                    const scoreA = a.distFromPrev + a.distToNext * 2;
                    const scoreB = b.distFromPrev + b.distToNext * 2;
                    return scoreA - scoreB;
                })[0];

            let entryIntersection = entryCandidate ? entryCandidate.intersection : null;
            let exitIntersection = exitCandidate ? exitCandidate.intersection : null;

            // ÂÖ•Âè£„Å®Âá∫Âè£„ÅåÂêå„ÅòÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (entryIntersection && exitIntersection && entryIntersection.id === exitIntersection.id) {
                // „Çà„ÇäÈÅ©Âàá„Å™ÁµÑ„ÅøÂêà„Çè„Åõ„ÇíÊé¢„Åô
                if (evaluatedIntersections.length > 1) {
                    const alternatives = evaluatedIntersections
                        .filter(e => e.intersection.id !== entryIntersection.id)
                        .sort((a, b) => a.score - b.score);
                    
                    if (alternatives.length > 0) {
                        // ÈÅìË∑Ø„ÅÆ‰ΩçÁΩÆ„Å´Âü∫„Å•„ÅÑ„Å¶‰ª£Êõø„ÇíÈÅ∏Êäû
                        if (entryCandidate.positionOnRoad < 0.5) {
                            // ÂÖ•Âè£„ÅåÂâçÂçä„Å™„Çâ„ÄÅÂá∫Âè£„ÇíÂæåÂçä„Åã„ÇâÈÅ∏Êäû
                            exitIntersection = alternatives.find(a => a.positionOnRoad > 0.5)?.intersection || exitIntersection;
                        } else {
                            // ÂÖ•Âè£„ÅåÂæåÂçä„Å™„Çâ„ÄÅÂÖ•Âè£„ÇíÂâçÂçä„Åã„ÇâÈÅ∏Êäû
                            entryIntersection = alternatives.find(a => a.positionOnRoad < 0.5)?.intersection || entryIntersection;
                        }
                    }
                }
            }

            console.log('ÈÅ∏Êäû„Åï„Çå„Åü‰∫§Â∑ÆÁÇπÔºàÊîπÂñÑÁâàÔºâ:', {
                entry: entryIntersection,
                exit: exitIntersection,
                isSame: entryIntersection && exitIntersection && entryIntersection.id === exitIntersection.id,
                candidateCount: evaluatedIntersections.length
            });

            return { entryIntersection, exitIntersection };
        }

        // 2„Å§„ÅÆÈÅìË∑Ø„ÅÆÂÖ±ÈÄö‰∫§Â∑ÆÁÇπ„ÇíË¶ã„Å§„Åë„ÇãÈñ¢Êï∞ÔºàÊîπÂñÑÁâàÔºâ
        function findCommonIntersection(intersections1, intersections2) {
            if (!intersections1 || !intersections2) return null;
            
            const commonIntersections = [];
            
            for (const int1 of intersections1) {
                for (const int2 of intersections2) {
                    // Â∫ßÊ®ô„ÅåÈùûÂ∏∏„Å´Ëøë„ÅÑÔºà10m‰ª•ÂÜÖÔºâÂ†¥Âêà„ÅØÂêå„Åò‰∫§Â∑ÆÁÇπ„Å®„Åø„Å™„Åô
                    const dist = calculateDistance(int1, int2);
                    if (dist < 0.01) { // 10m
                        commonIntersections.push({
                            ...int1,
                            distance: dist,
                            priority: int1.connectionCount + int2.connectionCount
                        });
                    }
                }
            }
            
            // Ë§áÊï∞„ÅÆÂÖ±ÈÄö‰∫§Â∑ÆÁÇπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅÊé•Á∂öÊï∞„ÅåÂ§ö„ÅÑ„ÇÇ„ÅÆ„ÇíÂÑ™ÂÖà
            if (commonIntersections.length > 0) {
                commonIntersections.sort((a, b) => b.priority - a.priority);
                console.log(`ÂÖ±ÈÄö‰∫§Â∑ÆÁÇπ„Çí${commonIntersections.length}ÁÆáÊâÄÁô∫Ë¶ã„ÄÅÊúÄÂÑ™ÂÖà„ÇíÈÅ∏Êäû:`, commonIntersections[0]);
                return commonIntersections[0];
            }
            
            return null;
        }

        // ÈÅìË∑Ø„ÅåÂÆüÈöõ„Å´Êé•Á∂ö„Åó„Å¶„ÅÑ„Çã„Åã„ÇíÁ¢∫Ë™ç„Åô„ÇãÈñ¢Êï∞
        function areRoadsConnected(roadInfo1, roadInfo2) {
            // ‰∏°Êñπ„ÅÆÈÅìË∑Ø„ÅÆÂÖ®Â∫ßÊ®ô„ÇíÂèñÂæó
            const coords1 = [];
            const coords2 = [];
            
            roadInfo1.roadSegments.forEach(seg => {
                const coordinates = seg.coordinates || seg;
                if (Array.isArray(coordinates)) {
                    coordinates.forEach(coord => {
                        if (Array.isArray(coord) && coord.length >= 2) {
                            coords1.push({ lat: coord[0], lng: coord[1] });
                        }
                    });
                }
            });
            
            roadInfo2.roadSegments.forEach(seg => {
                const coordinates = seg.coordinates || seg;
                if (Array.isArray(coordinates)) {
                    coordinates.forEach(coord => {
                        if (Array.isArray(coord) && coord.length >= 2) {
                            coords2.push({ lat: coord[0], lng: coord[1] });
                        }
                    });
                }
            });
            
            // ÂÖ±ÈÄö„ÅÆÂ∫ßÊ®ôÁÇπ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            for (const c1 of coords1) {
                for (const c2 of coords2) {
                    if (calculateDistance(c1, c2) < 0.005) { // 5m‰ª•ÂÜÖ
                        return true;
                    }
                }
            }
            
            return false;
        }

        // Â∫ßÊ®ôÁµêÊûú„ÅÆË°®Á§∫Èñ¢Êï∞ÔºàMap MatchingÁâà„Åß„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
        function displayCoordinates(viaPoints) {
            // „Åì„ÅÆÈñ¢Êï∞„ÅØÊñ∞„Åó„ÅÑMap MatchingÁâà„Åß„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ
            console.log('displayCoordinates: Map MatchingÁâà„Åß„ÅØ‰∏çË¶Å');
        }

        // OSMÈÅìË∑ØÊ§úÁ¥¢Èñ¢Êï∞Ôºà‰∫§Â∑ÆÁÇπÊÉÖÂ†±„ÇÇÂèñÂæó„ÉªÊîπÂñÑÁâàÔºâ
        async function searchOSMRoad(roadName, bbox) {
            console.log('OSMÈÅìË∑ØÊ§úÁ¥¢ÈñãÂßã:', roadName);
            
            // „Çà„ÇäÂ∫ÉÁØÑÂõ≤„ÅÆ‰∫§Â∑ÆÁÇπ„ÇíÊ§úÂá∫„Åô„Çã„Åü„ÇÅ„ÄÅ‰ªñ„ÅÆÈÅìË∑Ø„ÇÇÂê´„ÇÅ„Å¶Ê§úÁ¥¢
            const query = `
                [out:json][timeout:25];
                (
                  way["highway"]["name"="${roadName}"](${bbox});
                  way["highway"]["alt_name"="${roadName}"](${bbox});
                  way["highway"]["name:ja"="${roadName}"](${bbox});
                );
                (._;>;);
                out geom;
            `;

            const response = await fetch('https://overpass-api.de/api/interpreter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `data=${encodeURIComponent(query)}`
            });

            if (!response.ok) {
                throw new Error('ÈÅìË∑Ø„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }

            const osmData = await response.json();
            console.log('OSM Response:', osmData);
            
            const ways = osmData.elements.filter(el => el.type === 'way' && el.geometry);
            const nodes = osmData.elements.filter(el => el.type === 'node');
            
            if (ways.length === 0) {
                console.log('ÈÅìË∑Ø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', roadName);
                return { roadSegments: [], intersections: [] };
            }

            // ‰∫§Â∑ÆÁÇπÊ§úÂá∫Áî®„Å´‰ªñ„ÅÆ‰∏ªË¶ÅÈÅìË∑Ø„Å®„ÅÆ‰∫§Â∑Æ„ÇÇÊ§úÁ¥¢ÔºàÊîπÂñÑÁâàÔºâ
            const intersectionQuery = `
                [out:json][timeout:25];
                (
                  way["highway"]["name"="${roadName}"](${bbox});
                  way["highway"]["alt_name"="${roadName}"](${bbox});
                  way["highway"]["name:ja"="${roadName}"](${bbox});
                )->.target;
                way["highway"~"trunk|primary|secondary|tertiary|unclassified|residential"]["name"](${bbox})->.others;
                node(w.target)->.target_nodes;
                node(w.others)->.other_nodes;
                node.target_nodes.other_nodes;
                out;
            `;

            let additionalIntersections = [];
            try {
                const intersectionResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `data=${encodeURIComponent(intersectionQuery)}`
                });
                
                if (intersectionResponse.ok) {
                    const intersectionData = await intersectionResponse.json();
                    additionalIntersections = intersectionData.elements.filter(el => el.type === 'node');
                    console.log('ËøΩÂä†‰∫§Â∑ÆÁÇπÊ§úÂá∫:', additionalIntersections.length);
                }
            } catch (error) {
                console.warn('ËøΩÂä†‰∫§Â∑ÆÁÇπÊ§úÁ¥¢„Ç®„É©„Éº:', error);
            }

            // „Éé„Éº„Éâ„ÅÆ‰ΩøÁî®ÂõûÊï∞„Çí„Ç´„Ç¶„É≥„ÉàÔºà‰∫§Â∑ÆÁÇπ„ÅÆÊ§úÂá∫Ôºâ
            const nodeUsageCount = {};
            const nodeWays = {}; // „Å©„ÅÆway„Å´Â±û„Åó„Å¶„ÅÑ„Çã„Åã„ÇíË®òÈå≤
            
            ways.forEach(way => {
                if (way.nodes) {
                    way.nodes.forEach(nodeId => {
                        nodeUsageCount[nodeId] = (nodeUsageCount[nodeId] || 0) + 1;
                        if (!nodeWays[nodeId]) nodeWays[nodeId] = [];
                        nodeWays[nodeId].push(way.id);
                    });
                }
            });

            // ‰∫§Â∑ÆÁÇπ„ÇíÊäΩÂá∫ÔºàË§áÊï∞„ÅÆway„ÅßÂÖ±Êúâ„Åï„Çå„Å¶„ÅÑ„Çãnode„ÄÅ„Åæ„Åü„ÅØÈÅìË∑Ø„ÅÆÁ´ØÁÇπÔºâ
            const intersections = [];
            const nodeMap = {};
            
            // „Éé„Éº„ÉâÊÉÖÂ†±„Çí„Éû„ÉÉ„ÉóÂåñ
            nodes.forEach(node => {
                if (node.id && node.lat && node.lon) {
                    nodeMap[node.id] = { 
                        lat: node.lat, 
                        lng: node.lon, 
                        id: node.id,
                        tags: node.tags || {}
                    };
                }
            });

            // ËøΩÂä†‰∫§Â∑ÆÁÇπ„ÇÇ„Éû„ÉÉ„Éó„Å´ËøΩÂä†
            additionalIntersections.forEach(node => {
                if (node.id && node.lat && node.lon && !nodeMap[node.id]) {
                    nodeMap[node.id] = { 
                        lat: node.lat, 
                        lng: node.lon, 
                        id: node.id,
                        tags: node.tags || {},
                        isAdditional: true
                    };
                }
            });

            // ‰∫§Â∑ÆÁÇπÂÄôË£ú„ÇíÂèéÈõÜÔºàÊîπÂñÑÁâàÔºâ
            const intersectionSet = new Set();
            
            ways.forEach(way => {
                if (way.nodes && way.nodes.length > 0) {
                    // ÈÅìË∑Ø„ÅÆÂßãÁÇπ„Å®ÁµÇÁÇπ„ÅØÂøÖ„Åö‰∫§Â∑ÆÁÇπÂÄôË£ú
                    const startNodeId = way.nodes[0];
                    const endNodeId = way.nodes[way.nodes.length - 1];
                    
                    [startNodeId, endNodeId].forEach(nodeId => {
                        if (nodeMap[nodeId]) {
                            intersectionSet.add(nodeId);
                        }
                    });
                    
                    // ‰∏≠Èñì„Éé„Éº„Éâ„ÇÇÊ§úÊüª
                    way.nodes.forEach((nodeId, index) => {
                        if (nodeMap[nodeId]) {
                            // ‰∫§Â∑ÆÁÇπ„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÊù°‰ª∂
                            // 1. Ë§áÊï∞„ÅÆway„ÅßÂÖ±Êúâ„Åï„Çå„Å¶„ÅÑ„Çã
                            // 2. traffic_signals, crossing „Å™„Å©„ÅÆ„Çø„Ç∞„Åå„ÅÇ„Çã
                            // 3. ËøΩÂä†‰∫§Â∑ÆÁÇπ„Å®„Åó„Å¶Ê§úÂá∫„Åï„Çå„Åü
                            const node = nodeMap[nodeId];
                            if (nodeUsageCount[nodeId] > 1 || 
                                node.tags.highway === 'traffic_signals' ||
                                node.tags.highway === 'crossing' ||
                                node.tags.junction ||
                                node.isAdditional) {
                                intersectionSet.add(nodeId);
                            }
                        }
                    });
                }
            });

            // ‰∫§Â∑ÆÁÇπÈÖçÂàó„ÇíÊßãÁØâ
            intersectionSet.forEach(nodeId => {
                const node = nodeMap[nodeId];
                if (node) {
                    intersections.push({
                        ...node,
                        type: nodeUsageCount[nodeId] > 1 ? 'intersection' : 'endpoint',
                        connectionCount: nodeUsageCount[nodeId] || 1,
                        connectedWays: nodeWays[nodeId] || []
                    });
                }
            });

            // ÈÅìË∑Ø„Çª„Ç∞„É°„É≥„Éà„ÇíÊßãÁØâ
            const roadSegments = [];
            ways.forEach(way => {
                if (way.geometry && way.geometry.length > 0) {
                    const coordinates = way.geometry.map(node => [node.lat, node.lon]);
                    roadSegments.push({
                        coordinates: coordinates,
                        wayId: way.id,
                        tags: way.tags || {}
                    });
                }
            });

            console.log(`${roadName}: „Çª„Ç∞„É°„É≥„ÉàÊï∞=${roadSegments.length}, ‰∫§Â∑ÆÁÇπÊï∞=${intersections.length}`);
            
            return { roadSegments, intersections };
        }

        // ÈÅìË∑ØÂêçÊ§úÁ¥¢Èñ¢Êï∞Ôºà‰∫§Â∑ÆÁÇπÊÉÖÂ†±„ÇÇ‰øùÂ≠òÔºâ
        async function searchRoadName(viaId, roadName) {
            console.log('ÈÅìË∑ØÂêçÊ§úÁ¥¢ÈñãÂßã:', { viaId, roadName });
            
            if (!roadName || !roadName.trim()) {
                console.log('ÈÅìË∑ØÂêç„ÅåÁ©∫„Åß„Åô');
                return;
            }

            const statusDiv = document.getElementById(`roadStatus_${viaId}`);
            if (!statusDiv) {
                console.error(`Status div not found for viaId: ${viaId}`);
                return;
            }

            statusDiv.style.display = 'block';
            statusDiv.className = 'road-status searching';
            statusDiv.textContent = 'ÈÅìË∑Ø„ÇíÊ§úÁ¥¢‰∏≠...';

            try {
                const bbox = '35.4,139.4,35.9,140.0'; // Êù±‰∫¨Âë®Ëæ∫ÔºàÊã°Â§ßÁâàÔºâ
                const { roadSegments, intersections } = await searchOSMRoad(roadName, bbox);
                
                if (roadSegments && roadSegments.length > 0) {
                    // ‰ªÆ„ÅÆÂâçÂæåÂú∞ÁÇπÔºàÈÅìË∑Ø„ÅÆ‰∏≠ÂøÉÁÇπ„ÇíÂü∫Ê∫ñ„Å´Ë®≠ÂÆöÔºâ
                    let allLats = [];
                    let allLngs = [];
                    roadSegments.forEach(segment => {
                        const coordinates = segment.coordinates || segment;
                        if (Array.isArray(coordinates)) {
                            coordinates.forEach(point => {
                                if (point && typeof point[0] === 'number' && typeof point[1] === 'number') {
                                    allLats.push(point[0]);
                                    allLngs.push(point[1]);
                                }
                            });
                        }
                    });
                    
                    if (allLats.length === 0 || allLngs.length === 0) {
                        throw new Error('ÊúâÂäπ„Å™Â∫ßÊ®ô„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    
                    const centerLat = allLats.reduce((a, b) => a + b, 0) / allLats.length;
                    const centerLng = allLngs.reduce((a, b) => a + b, 0) / allLngs.length;
                    
                    // ÈÅìË∑Ø„ÅÆ‰∏°Á´Ø„Çí‰ªÆ„ÅÆÂâçÂæåÂú∞ÁÇπ„Å®„Åô„Çã
                    const tempStart = { lat: allLats[0], lng: allLngs[0] };
                    const tempEnd = { lat: allLats[allLats.length - 1], lng: allLngs[allLngs.length - 1] };
                    
                    console.log('extractViaPoints Âëº„Å≥Âá∫„ÅóÂâç');
                    const viaPoints = extractViaPoints(roadSegments, roadName, tempStart, tempEnd);
                    console.log('extractViaPoints Âëº„Å≥Âá∫„ÅóÂæå:', viaPoints);
                    
                    if (viaPoints && viaPoints.length > 0) {
                        statusDiv.className = 'road-status found';
                        statusDiv.textContent = `‚úì ${roadName} (ÈÅìË∑Ø„ÇíÊ§úÂá∫, ‰∫§Â∑ÆÁÇπ${intersections.length}ÁÆáÊâÄ)`;
                        
                        // ÁµåÁî±ÁÇπ„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà‰∫§Â∑ÆÁÇπÊÉÖÂ†±„ÇÇÂê´„ÇÄÔºâ
                        const viaPointElement = document.getElementById(`viaPoint_${viaId}`);
                        if (viaPointElement) {
                            viaPointElement.dataset.viaPoints = JSON.stringify(viaPoints);
                            viaPointElement.dataset.roadSegments = JSON.stringify(roadSegments);
                            viaPointElement.dataset.intersections = JSON.stringify(intersections);
                            console.log('„Éá„Éº„Çø‰øùÂ≠òÂÆå‰∫Ü');
                        }
                        
                        // Âú∞Âõ≥„Å´Ë°®Á§∫ÔºàÈÅìË∑Ø„Çª„Ç∞„É°„É≥„Éà„Å®‰∫§Â∑ÆÁÇπÔºâ
                        displayViaPointsOnMap(viaId, intersections, roadName);
                        
                        // „Ç∞„É≠„Éº„Éê„É´„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
                        showStatus(`${roadName} „ÇíÊ§úÂá∫„Åó„Åæ„Åó„Åü (‰∫§Â∑ÆÁÇπ${intersections.length}ÁÆáÊâÄ)`, 'success');
                    } else {
                        throw new Error('ÁµåÁî±ÁÇπ„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
                    }
                } else {
                    statusDiv.className = 'road-status not-found';
                    statusDiv.textContent = `‚úó ${roadName} „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`;
                    showStatus(`${roadName} „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü`, 'error');
                }
            } catch (error) {
                console.error('ÈÅìË∑ØÊ§úÁ¥¢„Ç®„É©„Éº:', error);
                statusDiv.className = 'road-status not-found';
                statusDiv.textContent = `‚úó Ê§úÁ¥¢„Ç®„É©„Éº: ${error.message}`;
                showStatus(`${roadName} „ÅÆÊ§úÁ¥¢„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error.message}`, 'error');
            }
        }

        // ‰ª£Ë°®Â∫ßÊ®ô„ÅÆÊäΩÂá∫Èñ¢Êï∞ÔºàÊîπÂñÑÁâàÔºâ
        function extractViaPoints(roadSegments, roadName, prevPoint, nextPoint) {
            console.log('extractViaPoints: Á∞°ÊòìË°®Á§∫Áî®');
            
            if (!roadSegments || roadSegments.length === 0) {
                return [];
            }

            // „Åô„Åπ„Å¶„ÅÆÂ∫ßÊ®ô„ÇíÂèéÈõÜ
            const allCoords = [];
            roadSegments.forEach(segment => {
                const coordinates = segment.coordinates || segment;
                if (Array.isArray(coordinates)) {
                    coordinates.forEach(coord => {
                        if (Array.isArray(coord) && coord.length >= 2) {
                            allCoords.push({
                                lat: coord[0],
                                lng: coord[1]
                            });
                        }
                    });
                }
            });

            if (allCoords.length === 0) {
                console.log('ÊúâÂäπ„Å™Â∫ßÊ®ô„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return [];
            }

            // Á∞°ÊòìÁâàÔºöÊúÄÂàù„Å®‰∏≠Èñì„Å®ÊúÄÂæå„ÅÆÂ∫ßÊ®ô„ÇíËøî„Åô
            const result = [];
            
            // ÊúÄÂàù„ÅÆÂ∫ßÊ®ô
            if (allCoords.length > 0) {
                result.push({
                    lat: allCoords[0].lat,
                    lng: allCoords[0].lng,
                    type: 'via',
                    roadName: roadName,
                    index: 0
                });
            }
            
            // ‰∏≠ÈñìÂ∫ßÊ®ôÔºàÂ∫ßÊ®ôÊï∞„Åå3‰ª•‰∏ä„ÅÆÂ†¥ÂêàÔºâ
            if (allCoords.length > 2) {
                const midIndex = Math.floor(allCoords.length / 2);
                result.push({
                    lat: allCoords[midIndex].lat,
                    lng: allCoords[midIndex].lng,
                    type: 'via',
                    roadName: roadName,
                    index: 1
                });
            }
            
            // ÊúÄÂæå„ÅÆÂ∫ßÊ®ôÔºàÂ∫ßÊ®ôÊï∞„Åå2‰ª•‰∏ä„ÅÆÂ†¥ÂêàÔºâ
            if (allCoords.length > 1) {
                result.push({
                    lat: allCoords[allCoords.length - 1].lat,
                    lng: allCoords[allCoords.length - 1].lng,
                    type: 'via',
                    roadName: roadName,
                    index: result.length
                });
            }
            
            console.log(`${roadName}: ÊäΩÂá∫„Åï„Çå„Åü‰ª£Ë°®ÁÇπÊï∞=${result.length}`);
            return result;
        }

        // ÁµåÁî±ÁÇπ„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫„Åô„ÇãÈñ¢Êï∞Ôºà‰∫§Â∑ÆÁÇπ„ÇÇË°®Á§∫Ôºâ
        function displayViaPointsOnMap(viaId, intersections, roadName) {
            console.log('ÁµåÁî±ÁÇπÂú∞Âõ≥Ë°®Á§∫Ôºà‰∫§Â∑ÆÁÇπÁâàÔºâ:', { viaId, roadName, intersectionCount: intersections ? intersections.length : 0 });
            
            if (!viaMarkersLayer) {
                console.error('viaMarkersLayer „ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            // Êó¢Â≠ò„ÅÆ„Éû„Éº„Ç´„Éº„Çí„ÇØ„É™„Ç¢ÔºàË©≤ÂΩì„Åô„ÇãÈÅìË∑Ø„ÅÆ„ÅøÔºâ
            viaMarkersLayer.eachLayer(layer => {
                if (layer.viaId === viaId) {
                    viaMarkersLayer.removeLayer(layer);
                }
            });

            // ÈÅìË∑Ø„Çª„Ç∞„É°„É≥„Éà„ÅÆË°®Á§∫ÔºàÂçäÈÄèÊòé„ÅÆËµ§Á∑öÔºâ
            const roadSegmentsData = document.getElementById(`viaPoint_${viaId}`)?.dataset.roadSegments;
            if (roadSegmentsData) {
                try {
                    const roadSegments = JSON.parse(roadSegmentsData);
                    roadSegments.forEach(segment => {
                        // segment„Åå„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà„Å®„Åù„ÅÜ„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ‰∏°Êñπ„Å´ÂØæÂøú
                        const coordinates = segment.coordinates || segment;
                        if (Array.isArray(coordinates)) {
                            const polyline = L.polyline(coordinates, {
                                color: '#e74c3c',
                                weight: 3,
                                opacity: 0.5
                            }).addTo(viaMarkersLayer);
                            polyline.viaId = viaId;
                        }
                    });
                } catch (error) {
                    console.error('ÈÅìË∑Ø„Çª„Ç∞„É°„É≥„ÉàË°®Á§∫„Ç®„É©„Éº:', error);
                }
            }
            
            // ‰∫§Â∑ÆÁÇπ„ÇíË°®Á§∫
            if (intersections && Array.isArray(intersections)) {
                intersections.forEach((intersection, index) => {
                    if (intersection && typeof intersection.lat === 'number' && typeof intersection.lng === 'number') {
                        // ‰∫§Â∑ÆÁÇπ„ÅÆÁ®ÆÈ°û„Å´Âøú„Åò„Å¶„Ç¢„Ç§„Ç≥„É≥„ÇíÂ§âÊõ¥
                        let iconColor;
                        let iconSize;
                        if (intersection.type === 'intersection' && intersection.connectionCount > 3) {
                            iconColor = '#e74c3c'; // ‰∏ªË¶Å‰∫§Â∑ÆÁÇπ„ÅØËµ§
                            iconSize = 24;
                        } else if (intersection.type === 'intersection') {
                            iconColor = '#3498db'; // ÈÄöÂ∏∏„ÅÆ‰∫§Â∑ÆÁÇπ„ÅØÈùí
                            iconSize = 20;
                        } else {
                            iconColor = '#9b59b6'; // Á´ØÁÇπ„ÅØÁ¥´
                            iconSize = 16;
                        }
                        
                        const icon = L.divIcon({
                            html: `<div style="background: ${iconColor}; color: white; border-radius: 50%; width: ${iconSize}px; height: ${iconSize}px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 10px;">‚óè</div>`,
                            iconSize: [iconSize, iconSize],
                            iconAnchor: [iconSize/2, iconSize/2]
                        });
                        
                        const popupContent = `
                            <strong>${roadName}</strong><br>
                            ${intersection.type === 'intersection' ? '‰∫§Â∑ÆÁÇπ' : 'Á´ØÁÇπ'}<br>
                            Êé•Á∂öÊï∞: ${intersection.connectionCount || 1}<br>
                            <small>ID: ${intersection.id}</small>
                        `;
                        
                        const marker = L.marker([intersection.lat, intersection.lng], { icon })
                            .bindPopup(popupContent)
                            .addTo(viaMarkersLayer);
                        
                        marker.viaId = viaId;
                    }
                });
            }
            
            console.log('ÈÅìË∑Ø„Éª‰∫§Â∑ÆÁÇπË°®Á§∫ÂÆå‰∫Ü');
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫Èñ¢Êï∞
        function showStatus(message, type = 'info') {
            console.log('Status:', message, type);
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.className = `status ${type}`;
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
            }
        }

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫Âà∂Âæ°
        function showLoading(show = true) {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.className = show ? 'loading show' : 'loading';
            }
        }

        // Âú∞Âõ≥ÂàùÊúüÂåñ
        function initMap() {
            console.log('Âú∞Âõ≥ÂàùÊúüÂåñÈñãÂßã');
            
            map = L.map('map').setView([35.6762, 139.6503], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            viaMarkersLayer = L.layerGroup().addTo(map);

            // Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            map.on('click', function(e) {
                if (isSelectingLocation) {
                    setLocationCoordinates(locationSelectType, e.latlng.lat, e.latlng.lng);
                    isSelectingLocation = false;
                    locationSelectType = null;
                    map.getContainer().style.cursor = '';
                }
            });
            
            console.log('Âú∞Âõ≥ÂàùÊúüÂåñÂÆå‰∫Ü');
        }

        // ‰ΩèÊâÄÊ§úÁ¥¢
        async function geocodeAddress(address) {
            console.log('‰ΩèÊâÄÊ§úÁ¥¢:', address);
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1&accept-language=ja&countrycodes=jp`
                );
                const data = await response.json();
                
                if (data.length > 0) {
                    const result = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                    console.log('‰ΩèÊâÄÊ§úÁ¥¢ÁµêÊûú:', result);
                    return result;
                }
                throw new Error('‰ΩèÊâÄ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            } catch (error) {
                console.error('‰ΩèÊâÄÊ§úÁ¥¢„Ç®„É©„Éº:', error);
                throw new Error('‰ΩèÊâÄÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            }
        }

        // ÁèæÂú®Âú∞ÂèñÂæó
        function getCurrentLocation(type) {
            console.log('ÁèæÂú®Âú∞ÂèñÂæó:', type);
            
            if (!navigator.geolocation) {
                alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ‰ΩçÁΩÆÊÉÖÂ†±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }

            showLoading(true);
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setLocationCoordinates(type, lat, lng);
                    showLoading(false);
                },
                (error) => {
                    console.error('ÁèæÂú®Âú∞ÂèñÂæó„Ç®„É©„Éº:', error);
                    alert('ÁèæÂú®Âú∞„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    showLoading(false);
                }
            );
        }

        // Â∫ßÊ®ô„Åã„Çâ‰ΩèÊâÄ„ÇíÈÄÜ„Ç∏„Ç™„Ç≥„Éº„Éá„Ç£„É≥„Ç∞
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`
                );
                const data = await response.json();
                return data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        // Â∫ßÊ®ôË®≠ÂÆö
        async function setLocationCoordinates(type, lat, lng) {
            console.log('Â∫ßÊ®ôË®≠ÂÆö:', { type, lat, lng });
            
            const address = await reverseGeocode(lat, lng);
            
            if (type === 'start') {
                document.getElementById('startLocation').value = address;
                if (startMarker) map.removeLayer(startMarker);
                startMarker = L.marker([lat, lng], { icon: icons.start })
                    .bindPopup('Âá∫Áô∫Âú∞')
                    .addTo(map);
            } else if (type === 'end') {
                document.getElementById('endLocation').value = address;
                if (endMarker) map.removeLayer(endMarker);
                endMarker = L.marker([lat, lng], { icon: icons.end })
                    .bindPopup('ÁõÆÁöÑÂú∞')
                    .addTo(map);
            }
        }

        // Âú∞Âõ≥„Åã„Çâ‰ΩçÁΩÆÈÅ∏Êäû
        function setLocationFromMap(type) {
            isSelectingLocation = true;
            locationSelectType = type;
            map.getContainer().style.cursor = 'crosshair';
            alert('Âú∞Âõ≥‰∏ä„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰ΩçÁΩÆ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        }

        // ÁµåÁî±Âú∞ÁÇπËøΩÂä†
        function addViaPoint() {
            console.log('ÁµåÁî±Âú∞ÁÇπËøΩÂä†:', viaPointCounter + 1);
            
            viaPointCounter++;
            const viaPointsContainer = document.getElementById('viaPoints');
            
            if (!viaPointsContainer) {
                console.error('viaPoints container „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }
            
            const viaPointDiv = document.createElement('div');
            viaPointDiv.className = 'via-point';
            viaPointDiv.id = `viaPoint_${viaPointCounter}`;
            
            viaPointDiv.innerHTML = `
                <div class="via-point-header">
                    <span class="via-point-title">ÁµåÁî±ÈÅìË∑Ø ${viaPointCounter}</span>
                    <button class="btn-remove" onclick="removeViaPoint(${viaPointCounter})">√ó</button>
                </div>
                <input type="text" class="road-name-input" placeholder="‰æã: Â§ñÂ†ÄÈÄö„Çä, ÈùíÂ±±ÈÄö„Çä, Áî≤Â∑ûË°óÈÅì" 
                       onchange="searchRoadName(${viaPointCounter}, this.value)">
                <div class="road-status" id="roadStatus_${viaPointCounter}" style="display: none;"></div>
            `;
            
            viaPointsContainer.appendChild(viaPointDiv);
            console.log('ÁµåÁî±Âú∞ÁÇπËøΩÂä†ÂÆå‰∫Ü:', viaPointCounter);
        }

        // ÁµåÁî±Âú∞ÁÇπÂâäÈô§
        function removeViaPoint(id) {
            console.log('ÁµåÁî±Âú∞ÁÇπÂâäÈô§:', id);
            
            const viaPoint = document.getElementById(`viaPoint_${id}`);
            if (viaPoint) {
                // Âú∞Âõ≥„Åã„ÇâË©≤ÂΩì„Åô„Çã„Éû„Éº„Ç´„Éº„Å®ÈÅìË∑Ø„ÇíÂâäÈô§
                if (viaMarkersLayer) {
                    viaMarkersLayer.eachLayer(layer => {
                        if (layer.viaId === id) {
                            viaMarkersLayer.removeLayer(layer);
                        }
                    });
                }
                
                viaPoint.remove();
                console.log('ÁµåÁî±Âú∞ÁÇπÂâäÈô§ÂÆå‰∫Ü:', id);
            }
        }

        // „É´„Éº„ÉàË®àÁÆóÔºàMap MatchingÁâà + ‰∫§Â∑ÆÁÇπ‰ΩøÁî® + Turf.jsÊîπÂñÑÁâàÔºâ
        async function calculateRoute() {
            console.log('„É´„Éº„ÉàË®àÁÆóÈñãÂßãÔºàMap Matching + ‰∫§Â∑ÆÁÇπ + Turf.jsÁâàÔºâ');
            
            const startAddress = document.getElementById('startLocation').value.trim();
            const endAddress = document.getElementById('endLocation').value.trim();

            if (!startAddress || !endAddress) {
                alert('Âá∫Áô∫Âú∞„Å®ÁõÆÁöÑÂú∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            showLoading(true);
            document.getElementById('calculateBtn').disabled = true;
            showStatus('„É´„Éº„Éà„ÇíË®àÁÆó‰∏≠...', 'info');

            try {
                // Âá∫Áô∫Âú∞„ÉªÁõÆÁöÑÂú∞„ÅÆÂ∫ßÊ®ôÂèñÂæó
                let startCoords, endCoords;

                if (startMarker) {
                    startCoords = { lat: startMarker.getLatLng().lat, lng: startMarker.getLatLng().lng };
                } else {
                    startCoords = await geocodeAddress(startAddress);
                    if (startMarker) map.removeLayer(startMarker);
                    startMarker = L.marker([startCoords.lat, startCoords.lng], { icon: icons.start })
                        .bindPopup('Âá∫Áô∫Âú∞')
                        .addTo(map);
                }

                if (endMarker) {
                    endCoords = { lat: endMarker.getLatLng().lat, lng: endMarker.getLatLng().lng };
                } else {
                    endCoords = await geocodeAddress(endAddress);
                    if (endMarker) map.removeLayer(endMarker);
                    endMarker = L.marker([endCoords.lat, endCoords.lng], { icon: icons.end })
                        .bindPopup('ÁõÆÁöÑÂú∞')
                        .addTo(map);
                }

                // ÁµåÁî±ÈÅìË∑Ø„ÅÆÊÉÖÂ†±„ÇíÂèéÈõÜ
                const roadInfoList = [];
                const allViaPointElements = document.querySelectorAll('.via-point');
                
                for (const element of allViaPointElements) {
                    const roadSegmentsData = element.dataset.roadSegments;
                    const intersectionsData = element.dataset.intersections;
                    const roadNameInput = element.querySelector('.road-name-input');
                    
                    if (roadSegmentsData && roadNameInput && roadNameInput.value.trim()) {
                        try {
                            const roadSegments = JSON.parse(roadSegmentsData);
                            const intersections = intersectionsData ? JSON.parse(intersectionsData) : [];
                            const roadName = roadNameInput.value.trim();
                            
                            roadInfoList.push({
                                element: element,
                                roadName: roadName,
                                roadSegments: roadSegments,
                                intersections: intersections
                            });
                        } catch (error) {
                            console.error('ÈÅìË∑Ø„Éá„Éº„ÇøËß£Êûê„Ç®„É©„Éº:', error);
                        }
                    }
                }

                if (roadInfoList.length === 0) {
                    throw new Error('ÊúâÂäπ„Å™ÁµåÁî±ÈÅìË∑Ø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇÈÅìË∑ØÊ§úÁ¥¢„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }

                // ÂÖ®‰Ωì„ÅÆ„É´„Éº„Éà„ÇíÊßãÁØâ
                const completeRoute = [];
                let currentPosition = startCoords;
                const selectedIntersections = []; // ÈÅ∏Êäû„Åï„Çå„Åü‰∫§Â∑ÆÁÇπ„ÇíË®òÈå≤

                // Âú∞Âõ≥‰∏ä„ÅÆÊó¢Â≠ò„ÅÆ„É´„Éº„Éà„Çí„ÇØ„É™„Ç¢
                if (routeLayer) map.removeLayer(routeLayer);
                if (viaMarkersLayer) viaMarkersLayer.clearLayers();

                // ÂêÑÈÅìË∑Ø„Çª„Ç∞„É°„É≥„Éà„ÇíÂá¶ÁêÜ
                for (let i = 0; i < roadInfoList.length; i++) {
                    const roadInfo = roadInfoList[i];
                    showStatus(`${roadInfo.roadName} „ÅÆ„É´„Éº„Éà„ÇíË®àÁÆó‰∏≠...`, 'info');
                    
                    // Ê¨°„ÅÆÁõÆÁöÑÂú∞„ÇíÊ±∫ÂÆö
                    let nextDestination;
                    if (i < roadInfoList.length - 1) {
                        // Ê¨°„ÅÆÈÅìË∑Ø„Å®„ÅÆÂÖ±ÈÄö‰∫§Â∑ÆÁÇπ„ÇíÊé¢„Åô
                        const commonIntersection = findCommonIntersection(
                            roadInfo.intersections,
                            roadInfoList[i + 1].intersections
                        );
                        
                        if (commonIntersection) {
                            nextDestination = commonIntersection;
                            console.log(`${roadInfo.roadName} „Å® ${roadInfoList[i + 1].roadName} „ÅÆÂÖ±ÈÄö‰∫§Â∑ÆÁÇπ„Çí‰ΩøÁî®`);
                        } else {
                            // ÈÅìË∑Ø„ÅåÂÆüÈöõ„Å´Êé•Á∂ö„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
                            const connected = areRoadsConnected(roadInfo, roadInfoList[i + 1]);
                            if (!connected) {
                                console.warn(`Ë≠¶Âëä: ${roadInfo.roadName} „Å® ${roadInfoList[i + 1].roadName} „ÅØÊé•Á∂ö„Åó„Å¶„ÅÑ„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô`);
                            }
                            
                            // ÂÖ±ÈÄö‰∫§Â∑ÆÁÇπ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÊ¨°„ÅÆÈÅìË∑Ø„ÅÆÊúÄ„ÇÇËøë„ÅÑ‰∫§Â∑ÆÁÇπ„ÇíÈÅ∏Êäû
                            const { entryIntersection } = selectIntersections(
                                roadInfoList[i + 1].intersections,
                                currentPosition,
                                endCoords,
                                roadInfoList[i + 1].roadSegments
                            );
                            nextDestination = entryIntersection || endCoords;
                        }
                    } else {
                        nextDestination = endCoords;
                    }
                    
                    // „Åì„ÅÆÈÅìË∑Ø„ÅÆÂÖ•Âè£„ÉªÂá∫Âè£‰∫§Â∑ÆÁÇπ„ÇíÈÅ∏ÊäûÔºàÊîπÂñÑÁâàÔºâ
                    const { entryIntersection, exitIntersection } = selectIntersections(
                        roadInfo.intersections,
                        currentPosition,
                        nextDestination,
                        roadInfo.roadSegments
                    );
                    
                    if (!entryIntersection || !exitIntersection) {
                        console.warn(`${roadInfo.roadName} „ÅÆ‰∫§Â∑ÆÁÇπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:`, {
                            ‰∫§Â∑ÆÁÇπÁ∑èÊï∞: roadInfo.intersections.length,
                            ÂÖ•Âè£‰∫§Â∑ÆÁÇπ: entryIntersection,
                            Âá∫Âè£‰∫§Â∑ÆÁÇπ: exitIntersection
                        });
                        continue;
                    }
                    
                    selectedIntersections.push({
                        roadName: roadInfo.roadName,
                        entry: entryIntersection,
                        exit: exitIntersection
                    });
                    
                    // ÊúÄÂàù„ÅÆÈÅìË∑Ø„ÅÆÂ†¥Âêà„ÄÅÂá∫Áô∫Âú∞„Åã„ÇâÂÖ•Âè£‰∫§Â∑ÆÁÇπ„Å∏„ÅÆÊé•Á∂ö
                    if (i === 0 && calculateDistance(currentPosition, entryIntersection) > 0.05) {
                        const connectionGeometry = await getConnectionRoute(currentPosition, entryIntersection);
                        if (connectionGeometry) {
                            completeRoute.push(connectionGeometry);
                        }
                    }
                    
                    // ÂÖ•Âè£„Å®Âá∫Âè£„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÄÅÈÅìË∑Ø„Å´Ê≤ø„Å£„Åü„É´„Éº„Éà„ÇíÁîüÊàêÔºàTurf.js‰ΩøÁî®Ôºâ
                    if (entryIntersection.id !== exitIntersection.id) {
                        try {
                            // 1) MultiLineString „Çí‰ΩúÊàêÔºàÊñ∞„Åó„ÅÑÂΩ¢Âºè„Å´ÂØæÂøúÔºâ
                            const lineStrings = roadInfo.roadSegments.map(seg => {
                                const coords = seg.coordinates || seg;
                                return coords.map(pt => [pt[1], pt[0]]); // GeoJSON: [lng,lat]
                            });
                            
                            const multi = turf.multiLineString(lineStrings);
                            
                            // 2) ‰∏ÄÊú¨„ÅÆ LineString „Å´„Éû„Éº„Ç∏
                            const merged = turf.lineMerge(multi);
                            
                            // 3) „Éû„Éº„Ç∏ÁµêÊûú„ÅÆÁ¢∫Ë™ç
                            let lineToSlice;
                            if (merged.type === 'Feature' && merged.geometry.type === 'LineString') {
                                lineToSlice = merged;
                            } else if (merged.type === 'FeatureCollection' && merged.features.length > 0) {
                                // ÊúÄ„ÇÇÈï∑„ÅÑLineString„ÇíÈÅ∏Êäû
                                lineToSlice = merged.features.reduce((longest, current) => {
                                    if (current.geometry.type !== 'LineString') return longest;
                                    const currentLength = turf.length(current);
                                    const longestLength = longest ? turf.length(longest) : 0;
                                    return currentLength > longestLength ? current : longest;
                                }, null);
                            }
                            
                            if (lineToSlice) {
                                // 4) entry‚áîexit „ÅÆÂå∫Èñì„Å†„ÅëÂàá„ÇäÂá∫„Åó
                                const sliced = turf.lineSlice(
                                    turf.point([entryIntersection.lng, entryIntersection.lat]),
                                    turf.point([exitIntersection.lng, exitIntersection.lat]),
                                    lineToSlice
                                );
                                
                                // 5) Leaflet Áî®„Å´ [lat,lng] ÂΩ¢Âºè„ÅÆÈÖçÂàó„Å´Êàª„Åô
                                const roadCoords = sliced.geometry.coordinates.map(c => [c[1], c[0]]);
                                
                                // 6) Map Matching „Å∏Ê∏°„Åô
                                const matchedGeometry = await getMatchedRoute(roadCoords);
                                if (matchedGeometry) {
                                    completeRoute.push(matchedGeometry);
                                } else {
                                    // Map Matching „ÅåÂ§±Êïó„Åó„Åü„Çâ„ÄÅÂÖÉ„ÅÆÂàá„ÇäÂá∫„Åó„ÅüÂ∫ßÊ®ô„Çí‰ΩøÁî®
                                    completeRoute.push({
                                        type: 'LineString',
                                        coordinates: sliced.geometry.coordinates // GeoJSON [lng,lat]
                                    });
                                }
                            } else {
                                console.warn('ÈÅìË∑Ø„Çí„Éû„Éº„Ç∏„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü:', roadInfo.roadName);
                                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂçòÁ¥î„Å™Áõ¥Á∑öÊé•Á∂ö
                                const connectionGeometry = await getConnectionRoute(entryIntersection, exitIntersection);
                                if (connectionGeometry) {
                                    completeRoute.push(connectionGeometry);
                                }
                            }
                        } catch (error) {
                            console.error('Turf.jsÂá¶ÁêÜ„Ç®„É©„Éº:', error);
                            // „Ç®„É©„ÉºÊôÇ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂçòÁ¥î„Å™Êé•Á∂ö
                            const connectionGeometry = await getConnectionRoute(entryIntersection, exitIntersection);
                            if (connectionGeometry) {
                                completeRoute.push(connectionGeometry);
                            }
                        }
                    }
                    
                    // UI„ÇíÊõ¥Êñ∞
                    const statusDiv = roadInfo.element.querySelector('.road-status');
                    if (statusDiv) {
                        statusDiv.textContent = `‚úì ${roadInfo.roadName} („É´„Éº„ÉàË®àÁÆóÂÆå‰∫Ü)`;
                        statusDiv.className = 'road-status found';
                    }
                    
                    // ÈÅìË∑Ø„Çª„Ç∞„É°„É≥„Éà„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫ÔºàËñÑ„ÅÑËµ§Á∑öÔºâ
                    roadInfo.roadSegments.forEach(segment => {
                        const coordinates = segment.coordinates || segment;
                        if (Array.isArray(coordinates)) {
                            L.polyline(coordinates, {
                                color: '#e74c3c',
                                weight: 3,
                                opacity: 0.5
                            }).addTo(viaMarkersLayer);
                        }
                    });
                    
                    // ÈÅ∏Êäû„Åï„Çå„Åü‰∫§Â∑ÆÁÇπ„Çí„Éû„Éº„Ç´„Éº„ÅßË°®Á§∫ÔºàË©≥Á¥∞ÊÉÖÂ†±‰ªò„ÅçÔºâ
                    if (entryIntersection.id !== exitIntersection.id) {
                        // ÂÖ•Âè£‰∫§Â∑ÆÁÇπ
                        L.marker([entryIntersection.lat, entryIntersection.lng], { icon: icons.via })
                            .bindPopup(`${roadInfo.roadName}<br>ÂÖ•Âè£‰∫§Â∑ÆÁÇπ<br>ID: ${entryIntersection.id}<br>Êé•Á∂öÊï∞: ${entryIntersection.connectionCount || 1}`)
                            .addTo(viaMarkersLayer);
                        
                        // Âá∫Âè£‰∫§Â∑ÆÁÇπ
                        L.marker([exitIntersection.lat, exitIntersection.lng], { icon: icons.via })
                            .bindPopup(`${roadInfo.roadName}<br>Âá∫Âè£‰∫§Â∑ÆÁÇπ<br>ID: ${exitIntersection.id}<br>Êé•Á∂öÊï∞: ${exitIntersection.connectionCount || 1}`)
                            .addTo(viaMarkersLayer);
                    } else {
                        // ÂÖ•Âè£„Å®Âá∫Âè£„ÅåÂêå„ÅòÂ†¥Âêà
                        L.marker([entryIntersection.lat, entryIntersection.lng], { icon: icons.via })
                            .bindPopup(`${roadInfo.roadName}<br>ÈÄöÈÅé‰∫§Â∑ÆÁÇπ<br>ID: ${entryIntersection.id}<br>Êé•Á∂öÊï∞: ${entryIntersection.connectionCount || 1}`)
                            .addTo(viaMarkersLayer);
                    }
                    
                    // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±„Çí„Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫Âäõ
                    console.log(`${roadInfo.roadName} „É´„Éº„ÉàË©≥Á¥∞:`, {
                        ÂÖ•Âè£‰∫§Â∑ÆÁÇπ: {
                            id: entryIntersection.id,
                            Â∫ßÊ®ô: `${entryIntersection.lat.toFixed(6)}, ${entryIntersection.lng.toFixed(6)}`,
                            „Çø„Ç§„Éó: entryIntersection.type,
                            Êé•Á∂öÊï∞: entryIntersection.connectionCount
                        },
                        Âá∫Âè£‰∫§Â∑ÆÁÇπ: {
                            id: exitIntersection.id,
                            Â∫ßÊ®ô: `${exitIntersection.lat.toFixed(6)}, ${exitIntersection.lng.toFixed(6)}`,
                            „Çø„Ç§„Éó: exitIntersection.type,
                            Êé•Á∂öÊï∞: exitIntersection.connectionCount
                        },
                        ÈÅìË∑Ø„Çª„Ç∞„É°„É≥„ÉàÊï∞: roadInfo.roadSegments.length,
                        ‰∫§Â∑ÆÁÇπÁ∑èÊï∞: roadInfo.intersections.length
                    });
                    
                    // ÁèæÂú®‰ΩçÁΩÆ„ÇíÊõ¥Êñ∞
                    currentPosition = exitIntersection;
                }
                
                // ÊúÄÂæå„ÅÆÈÅìË∑Ø„Åã„ÇâÁõÆÁöÑÂú∞„Å∏„ÅÆÊé•Á∂ö
                if (currentPosition && calculateDistance(currentPosition, endCoords) > 0.05) {
                    const connectionGeometry = await getConnectionRoute(currentPosition, endCoords);
                    if (connectionGeometry) {
                        completeRoute.push(connectionGeometry);
                    }
                }
                
                // ÂÖ®‰Ωì„ÅÆ„É´„Éº„Éà„ÇíÁµêÂêà„Åó„Å¶Ë°®Á§∫
                if (completeRoute.length > 0) {
                    // „Åô„Åπ„Å¶„ÅÆGeometry„Çí‰∏Ä„Å§„ÅÆMultiLineString„Å´ÁµêÂêà
                    const allCoordinates = [];
                    let totalDistance = 0;
                    
                    completeRoute.forEach(geometry => {
                        if (geometry.type === 'LineString' && geometry.coordinates) {
                            // ÂêÑ„Çª„Ç∞„É°„É≥„Éà„ÅÆË∑ùÈõ¢„ÇíË®àÁÆó
                            for (let i = 0; i < geometry.coordinates.length - 1; i++) {
                                const p1 = {
                                    lat: geometry.coordinates[i][1],
                                    lng: geometry.coordinates[i][0]
                                };
                                const p2 = {
                                    lat: geometry.coordinates[i + 1][1],
                                    lng: geometry.coordinates[i + 1][0]
                                };
                                totalDistance += calculateDistance(p1, p2);
                            }
                            
                            // Â∫ßÊ®ô„ÇíËøΩÂä†
                            geometry.coordinates.forEach(coord => {
                                allCoordinates.push([coord[1], coord[0]]); // [lat, lng]ÂΩ¢Âºè
                            });
                        }
                    });
                    
                    // „É´„Éº„Éà„ÇíÂú∞Âõ≥„Å´Ë°®Á§∫
                    if (allCoordinates.length > 0) {
                        routeLayer = L.polyline(allCoordinates, {
                            color: '#2ecc71',
                            weight: 6,
                            opacity: 0.8
                        }).addTo(map);
                        
                        // „É´„Éº„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
                        document.getElementById('routeDistance').textContent = totalDistance.toFixed(1) + ' km';
                        document.getElementById('routeTime').textContent = Math.round(totalDistance * 3) + ' ÂàÜ'; // Ê¶ÇÁÆó
                        
                        // ÁµåÁî±ÈÅìË∑Ø„É™„Çπ„Éà„ÇíË°®Á§∫
                        const viaRoadsList = document.getElementById('viaRoadsList');
                        if (viaRoadsList) {
                            viaRoadsList.innerHTML = selectedIntersections
                                .map((info, idx) => {
                                    const samePoint = info.entry.id === info.exit.id;
                                    return `${idx + 1}. ${info.roadName} ${samePoint ? '(ÈÄöÈÅé)' : '(ÂÖ•Âè£‚ÜíÂá∫Âè£)'}`;
                                })
                                .join('<br>');
                        }
                        
                        document.getElementById('routeInfoSection').style.display = 'block';
                        
                        // Âú∞Âõ≥„Çí„É´„Éº„ÉàÂÖ®‰Ωì„Å´„Éï„Ç£„ÉÉ„Éà
                        map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
                        
                        showStatus(`„É´„Éº„ÉàË®àÁÆóÂÆå‰∫Ü: ${totalDistance.toFixed(1)}kmÔºàÊ≠£Á¢∫„Å™ÈÅìË∑ØËøΩÂæìÔºâ`, 'success');
                    }
                } else {
                    throw new Error('„É´„Éº„Éà„ÅÆË®àÁÆó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }

            } catch (error) {
                console.error('„É´„Éº„ÉàË®àÁÆó„Ç®„É©„Éº:', error);
                alert(`„É´„Éº„ÉàË®àÁÆó„Ç®„É©„Éº: ${error.message}`);
                showStatus(`„É´„Éº„ÉàË®àÁÆó„Ç®„É©„Éº: ${error.message}`, 'error');
            } finally {
                showLoading(false);
                document.getElementById('calculateBtn').disabled = false;
            }
        }

        // „É´„Éº„Éà„ÇØ„É™„Ç¢
        function clearRoute() {
            console.log('„É´„Éº„Éà„ÇØ„É™„Ç¢');
            
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeLayer) map.removeLayer(routeLayer);
            if (viaMarkersLayer) viaMarkersLayer.clearLayers();

            startMarker = null;
            endMarker = null;
            routeLayer = null;
            currentRoute = null;

            document.getElementById('startLocation').value = '';
            document.getElementById('endLocation').value = '';
            document.getElementById('viaPoints').innerHTML = '';
            
            const routeInfoSection = document.getElementById('routeInfoSection');
            if (routeInfoSection) {
                routeInfoSection.style.display = 'none';
            }
            
            viaPointCounter = 0;
            showStatus('Âú∞Âõ≥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }

        // Âú∞Âõ≥„ÇíÁèæÂú®Âú∞„Å´ÁßªÂãï
        function centerMap() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 13);
                    },
                    () => {
                        map.setView([35.6762, 139.6503], 11); // Êù±‰∫¨ÈßÖ„Çí„Éá„Éï„Ç©„É´„Éà
                    }
                );
            } else {
                map.setView([35.6762, 139.6503], 11);
            }
        }

        // „É´„Éº„ÉàÂÖ®‰Ωì„ÇíË°®Á§∫
        function fitRoute() {
            if (routeLayer) {
                map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });
            } else if (startMarker && endMarker) {
                const group = new L.featureGroup([startMarker, endMarker]);
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
        }

        // ÂÖ•ÂäõË£úÂÆåÊ©üËÉΩ
        function setupAutocomplete() {
            const inputs = ['startLocation', 'endLocation'];
            inputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                        }
                    });
                }
            });
        }

        // ÂàùÊúüÂåñÔºàËá™ÂãïÊ§úÁ¥¢‰ªò„ÅçÔºâ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü - ÂàùÊúüÂåñÈñãÂßã');
            
            // Âü∫Êú¨Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
            initMap();
            setupAutocomplete();
            
            // ÂÆüÁî®‰æã„ÅÆ„Éá„Éº„Çø„ÇíË®≠ÂÆö
            document.getElementById('startLocation').value = 'Êù±‰∫¨ÈßÖ';
            document.getElementById('endLocation').value = 'Êñ∞ÂÆø„Çø„Ç´„Ç∑„Éû„É§';
            
            // Ëá™ÂãïË™¨Êòé„ÇíË°®Á§∫
            showStatus('„Éá„É¢„Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó‰∏≠... „Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ', 'info');
            
            // „Çµ„É≥„Éó„É´„ÅÆÁµåÁî±ÈÅìË∑Ø„ÇíËøΩÂä†„Åó„Å¶Ëá™ÂãïÊ§úÁ¥¢
            setTimeout(() => {
                console.log('ÁµåÁî±ÈÅìË∑Ø1ËøΩÂä†');
                addViaPoint();
                
                setTimeout(() => {
                    const firstInput = document.querySelector('.road-name-input');
                    if (firstInput) {
                        console.log('Â§ñÂ†ÄÈÄö„ÇäÊ§úÁ¥¢ÈñãÂßã');
                        firstInput.value = 'Â§ñÂ†ÄÈÄö„Çä';
                        searchRoadName(1, 'Â§ñÂ†ÄÈÄö„Çä');
                    }
                }, 100);
            }, 500);
            
            setTimeout(() => {
                console.log('ÁµåÁî±ÈÅìË∑Ø2ËøΩÂä†');
                addViaPoint();
                
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.road-name-input');
                    if (inputs[1]) {
                        console.log('ÂÖ≠Êú¨Êú®ÈÄö„ÇäÊ§úÁ¥¢ÈñãÂßã');
                        inputs[1].value = 'ÂÖ≠Êú¨Êú®ÈÄö„Çä';
                        searchRoadName(2, 'ÂÖ≠Êú¨Êú®ÈÄö„Çä');
                    }
                }, 100);
            }, 2000);
            
            setTimeout(() => {
                console.log('ÁµåÁî±ÈÅìË∑Ø3ËøΩÂä†');
                addViaPoint();
                
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.road-name-input');
                    if (inputs[2]) {
                        console.log('Â§ñËãëË•øÈÄö„ÇäÊ§úÁ¥¢ÈñãÂßã');
                        inputs[2].value = 'Â§ñËãëË•øÈÄö„Çä';
                        searchRoadName(3, 'Â§ñËãëË•øÈÄö„Çä');
                    }
                }, 100);
            }, 3500);
            
            setTimeout(() => {
                showStatus('„Éá„É¢„Éá„Éº„Çø„ÅÆÊ∫ñÂÇô„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ„Äå„É´„Éº„ÉàË®àÁÆó„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅÊåáÂÆö„Åó„ÅüÈÅìË∑Ø„ÇíÊ≠£Á¢∫„Å´ËøΩÂæì„Åô„Çã„É´„Éº„Éà„ÅåË®àÁÆó„Åï„Çå„Åæ„Åô„ÄÇ', 'success');
            }, 5500);
            
            console.log('ÂàùÊúüÂåñÂÆå‰∫Ü');
        });
    </script>
</body>
</html>